{"version":3,"file":"middleware.js","sourceRoot":"","sources":["../src/middleware.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA,iBAgMA;;AAjMA,2BAA2B;AAC3B,iCAAuC;AACvC,yBAAoB;AAEpB,IAAI,IAAI,GAAG,MAAM,CAAC;AAElB;IAAA;IAQA,CAAC;IAPC,+BAAO,GAAP,UAAQ,GAAG;QACT,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;IACnB,CAAC;IAED,+BAAO,GAAP,UAAQ,GAAG,EAAE,KAAK;QAChB,IAAI,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC;IACpB,CAAC;IACH,oBAAC;AAAD,CAAC,AARD,IAQC;AARY,sCAAa;AAU1B,IAAI,OAAO,CAAC;AAEZ,EAAE,CAAC,CAAC,OAAO,YAAY,KAAK,WAAW,CAAC,CAAC,CAAC;IACxC,OAAO,GAAG,YAAY,CAAC;AACzB,CAAC;AAAC,IAAI,CAAC,CAAC;IACN,OAAO,GAAG,IAAI,aAAa,EAAE,CAAC;AAChC,CAAC;AAED,EAAE,CAAC,CAAC,OAAO,QAAQ,KAAK,WAAW,CAAC,CAAC,CAAC;IACpC,IAAI,GAAG,QAAQ,CAAC;AAClB,CAAC;AAEY,QAAA,WAAW,GAAG,oCAAoC,CAAC;AACnD,QAAA,eAAe,GAAG,wCAAwC,CAAC;AAC3D,QAAA,gBAAgB,GAAG,yCAAyC,CAAC;AAC7D,QAAA,YAAY,GAAG,qCAAqC,CAAC;AAElE,oBAA2B,QAAQ;IACjC,IAAI,GAAG,QAAQ,CAAC;AAClB,CAAC;AAFD,gCAEC;AAED,kBAAyB,KAAK;IAC5B,OAAO,CAAC,OAAO,CAAC,aAAa,EAAE,KAAK,CAAC,CAAC;AACxC,CAAC;AAFD,4BAEC;AAED,oBAA2B,aAAa;IACtC,OAAO,GAAG,aAAa,CAAC;AAC1B,CAAC;AAFD,gCAEC;AAED,kBAAe,cAAM,OAAA,UAAA,IAAI,IAAI,OAAA,UAAM,MAAM;QACjC,cAAc,EAOlB,UAAU,EACV,KAAK,EACL,IAAI,EACJ,IAAI,EACJ,IAAI,EACJ,QAAQ,EACR,MAAM,EACN,SAAS,EACT,QAAQ,EACR,UAAU,EACV,IAAI,EACJ,OAAO,EAGH,eAAe,EACf,aAAa,EAEZ,WAAW,EAAE,SAAS,EAAE,WAAW,EAGpC,YAAY,EAUV,KAAK,EAqCT,QAAQ,cAwBN,MAAI;;;;iCAlGa,MAAM,CAAC,mBAAW,CAAC;gBAE1C,EAAE,CAAC,CAAC,OAAO,cAAc,KAAK,WAAW,CAAC,CAAC,CAAC;oBAC1C,MAAM,gBAAC,IAAI,CAAC,MAAM,CAAC,EAAC;gBACtB,CAAC;6BAeG,cAAc,qBAAd,cAAc,eAAd,cAAc,cAAd,cAAc,cAAd,cAAc,kBAAd,cAAc,oBAAd,cAAc,qBAAd,cAAc,uBAAd,cAAc,wBAAd,cAAc,oBAAd,cAAc,iBAAd,cAAc;kCAEM,aAAI,CAAC,cAAc,CAAC,eAAe,IAAI,EAAE,EAAE,MAAM,CAAC;gCACpD,OAAO,IAAI,EAAE;8BAEW,KAAK,iBAAL,KAAK,mBAAL,KAAK;+BAG9B;oBACnB,MAAM,EAAE,MAAM,IAAI,KAAK;oBACvB,OAAO,aACL,MAAM,EAAE,kBAAkB,IACvB,aAAa,CACjB;iBACF;gBAED,mBAAmB;gBACnB,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;4BACK,OAAO,CAAC,OAAO,CAAC,aAAa,CAAC;oBAE5C,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;wBACV,YAAY,CAAC,OAAO,CAAC,aAAa,GAAG,KAAK,CAAC;oBAC7C,CAAC;oBAAC,IAAI,CAAC,CAAC;wBACN,MAAM,gBAAC,IAAI,CAAC;gCACV,IAAI,EAAE,uBAAe;6BACtB,CAAC,EAAC;oBACL,CAAC;gBACH,CAAC;gBAED,cAAc;gBACd,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;oBACT,YAAY,CAAC,OAAO,CAAC,cAAc,CAAC,GAAG,kBAAkB,CAAC;oBAC1D,YAAY,CAAC,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,IAAI,EAAE,CAAC,CAAC;gBACjD,CAAC;gBAED,wBAAwB;gBACxB,EAAE,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC;oBACf,YAAY,CAAC,OAAO,CAAC,cAAc,CAAC,GAAG,mCAAmC,CAAC;oBAC3E,YAAY,CAAC,IAAI,GAAG,YAAE,CAAC,SAAS,CAAC,IAAI,IAAI,EAAE,CAAC,CAAC;gBAC/C,CAAC;gBAED,WAAW;gBACX,EAAE,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;oBACb,YAAY,CAAC,IAAI,GAAG,IAAI,QAAQ,EAAE,CAAC;oBACnC,gBAAO,CAAC,IAAI,EAAE,UAAC,GAAG,EAAE,GAAG;wBACrB,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;4BACR,EAAE,CAAC,CAAC,GAAG,YAAY,QAAQ,CAAC,CAAC,CAAC;gCAC5B,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,EAAE,UAAA,IAAI,IAAI,OAAA,YAAY,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,EAAE,IAAI,CAAC,EAAnC,CAAmC,CAAC,CAAC;4BACpE,CAAC;4BAAC,IAAI,CAAC,CAAC;gCACN,YAAY,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;4BACrC,CAAC;wBACH,CAAC;oBACH,CAAC,CAAC,CAAC;gBACL,CAAC;;;;gBAKC,iBAAiB;gBACjB,EAAE,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC;oBAChB,IAAI,CAAC;wBACH,IAAI,EAAE,WAAW;wBACjB,UAAU,YAAA;wBACV,YAAY,cAAA;qBACb,CAAC,CAAC;gBACL,CAAC;gBAED,0BAA0B;gBAC1B,IAAI,CAAC;oBACH,IAAI,EAAE,wBAAgB;iBACvB,CAAC,CAAC;gBAEc,qBAAM,KAAK,CAAC,MAAG,IAAI,IAAI,IAAI,IAAG,UAAY,EAAE,YAAY,CAAC,EAAA;;6BAAzD,SAAyD;gBAE1E,wBAAwB;gBACxB,IAAI,CAAC;oBACH,IAAI,EAAE,oBAAY;iBACnB,CAAC,CAAC;qBAGC,UAAQ,CAAC,EAAE,EAAX,wBAAW;qBACT,CAAA,UAAQ,CAAC,MAAM,KAAK,GAAG,CAAA,EAAvB,wBAAuB;gBACzB,MAAI,GAAG,EAAE,CAAC;;oBAEH,qBAAM,UAAQ,CAAC,IAAI,EAAE,EAAA;;gBAA5B,MAAI,GAAG,SAAqB,CAAC;;;oBAGxB,qBAAM,UAAQ,CAAC,IAAI,EAAE,EAAA;;gBAA5B,MAAI,GAAG,SAAqB,CAAC;gBAE7B,EAAE,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;oBACb,QAAQ,CAAC,UAAQ,CAAC,OAAO,EAAE,MAAI,EAAE,UAAQ,CAAC,CAAC;gBAC7C,CAAC;gBAED,sBAAO,IAAI,cACN,eAAe,IAClB,KAAK,EAAE,UAAQ,CAAC,OAAO,EACvB,OAAO,EAAE,MAAI,EACb,QAAQ,EAAE,UAAQ,EAClB,IAAI,EAAE,SAAS,IACf,EAAC;;;;gBAGL,EAAE,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;oBACb,QAAQ,CAAC,OAAK,CAAC,OAAO,EAAE,OAAK,CAAC,CAAC;gBACjC,CAAC;gBAED,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;oBACd,IAAI,cACC,eAAe,IAClB,KAAK,SAAA,EACL,IAAI,EAAE,SAAS,IACf,CAAC;gBACL,CAAC;gBAED,sBAAO,OAAO,CAAC,KAAK,CAAC,OAAK,CAAC,EAAC;;gBAG9B,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;oBACd,SAAS,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;gBAC5B,CAAC;gBAED,sBAAO,IAAI,cACN,eAAe,IAClB,OAAO,EAAE,IAAI,EACb,QAAQ,EAAE,QAAQ,EAClB,IAAI,EAAE,WAAW,IACjB,EAAC;;;KACJ,EAnJ4B,CAmJ5B,EAnJoB,CAmJpB,CAAC","sourcesContent":["/* global API_HOST:false */\nimport { omit, forEach } from \"lodash\";\nimport qs from \"qs\";\n\nlet HOST = \"/api\";\n\nexport class SimpleStorage {\n  getItem(key) {\n    return this[key];\n  }\n\n  setItem(key, value) {\n    this[key] = value;\n  }\n}\n\nlet storage;\n\nif (typeof localStorage !== \"undefined\") {\n  storage = localStorage;\n} else {\n  storage = new SimpleStorage();\n}\n\nif (typeof API_HOST !== \"undefined\") {\n  HOST = API_HOST;\n}\n\nexport const API_REQUEST = \"REDUX_MIDDLEWARE_FETCH/API_REQUEST\";\nexport const NO_TOKEN_STORED = \"REDUX_MIDDLEWARE_FETCH/NO_TOKEN_STORED\";\nexport const API_REQUEST_SENT = \"REDUX_MIDDLEWARE_FETCH/API_REQUEST_SENT\";\nexport const API_FINISHED = \"REDUX_MIDDLEWARE_FETCH/API_FINISHED\";\n\nexport function setAPIHost(API_HOST) {\n  HOST = API_HOST;\n}\n\nexport function setToken(token) {\n  storage.setItem(\"accessToken\", token);\n}\n\nexport function setStorage(customStorage) {\n  storage = customStorage;\n}\n\nexport default () => next => async action => {\n  const requestOptions = action[API_REQUEST];\n\n  if (typeof requestOptions === \"undefined\") {\n    return next(action);\n  }\n\n  const {\n    entrypoint,\n    types,\n    auth,\n    json,\n    body,\n    formData,\n    method,\n    onSuccess,\n    onFailed,\n    urlEncoded,\n    fqdn,\n    headers\n  } = requestOptions;\n\n  const dispatchPayload = omit(requestOptions.dispatchPayload || {}, \"type\");\n  const customHeaders = headers || {};\n\n  const [successType, errorType, requestType] = types;\n\n  // Fetch Endpoint\n  const fetchOptions = {\n    method: method || \"GET\",\n    headers: {\n      Accept: \"application/json\",\n      ...customHeaders\n    }\n  };\n\n  // Inject JWT Token\n  if (auth) {\n    const token = storage.getItem(\"accessToken\");\n\n    if (token) {\n      fetchOptions.headers.Authorization = token;\n    } else {\n      return next({\n        type: NO_TOKEN_STORED\n      });\n    }\n  }\n\n  // ContentType\n  if (json) {\n    fetchOptions.headers[\"Content-Type\"] = \"application/json\";\n    fetchOptions.body = JSON.stringify(body || {});\n  }\n\n  // x-www-form-urlencoded\n  if (urlEncoded) {\n    fetchOptions.headers[\"Content-Type\"] = \"application/x-www-form-urlencoded\";\n    fetchOptions.body = qs.stringify(body || {});\n  }\n\n  // FormData\n  if (formData) {\n    fetchOptions.body = new FormData();\n    forEach(body, (val, key) => {\n      if (val) {\n        if (val instanceof FileList) {\n          [].forEach.call(val, file => fetchOptions.body.append(key, file));\n        } else {\n          fetchOptions.body.append(key, val);\n        }\n      }\n    });\n  }\n\n  let response;\n\n  try {\n    // Before Request\n    if (requestType) {\n      next({\n        type: requestType,\n        entrypoint,\n        fetchOptions\n      });\n    }\n\n    // Request Animation Start\n    next({\n      type: API_REQUEST_SENT\n    });\n\n    const response = await fetch(`${fqdn || HOST}${entrypoint}`, fetchOptions);\n\n    // Request Animation End\n    next({\n      type: API_FINISHED\n    });\n\n    let json;\n    if (response.ok) {\n      if (response.status === 204) {\n        json = {};\n      } else {\n        json = await response.json();\n      }\n    } else {\n      json = await response.json();\n\n      if (onFailed) {\n        onFailed(response.message, json, response);\n      }\n\n      return next({\n        ...dispatchPayload,\n        error: response.message,\n        payload: json,\n        response: response,\n        type: errorType\n      });\n    }\n  } catch (error) {\n    if (onFailed) {\n      onFailed(error.message, error);\n    }\n\n    if (errorType) {\n      next({\n        ...dispatchPayload,\n        error,\n        type: errorType\n      });\n    }\n\n    return console.error(error);\n  }\n\n  if (onSuccess) {\n    onSuccess(json, response);\n  }\n\n  return next({\n    ...dispatchPayload,\n    payload: json,\n    response: response,\n    type: successType\n  });\n};\n"]}