{"version":3,"file":"middleware.js","sourceRoot":"","sources":["../src/middleware.js"],"names":[],"mappings":"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","sourcesContent":["import { omit, forEach, uniqueId } from \"lodash\";\nimport qs from \"qs\";\n\nexport class SimpleStorage {\n  getItem(key) {\n    return this[key];\n  }\n\n  setItem(key, value) {\n    this[key] = value;\n  }\n}\n\nlet storage = new SimpleStorage();\n\nexport const API_REQUEST = \"REDUX_MIDDLEWARE_FETCH/API_REQUEST\";\nexport const API_NO_TOKEN_STORED = \"REDUX_MIDDLEWARE_FETCH/API_NO_TOKEN_STORED\";\nexport const API_REQUEST_START = \"REDUX_MIDDLEWARE_FETCH/API_REQUEST_START\";\nexport const API_REQUEST_END = \"REDUX_MIDDLEWARE_FETCH/API_REQUEST_END\";\n\nexport function setAPIHost(host) {\n  storage.setItem(\"host\", host);\n}\n\nexport function setToken(token) {\n  storage.setItem(\"accessToken\", token);\n}\n\nexport function setStorage(customStorage) {\n  storage = customStorage;\n}\n\nexport default () => next => async action => {\n  const requestOptions = action[API_REQUEST];\n\n  if (typeof requestOptions === \"undefined\") {\n    return next(action);\n  }\n\n  const {\n    entrypoint,\n    types,\n    auth,\n    json,\n    body,\n    formData,\n    method,\n    onSuccess,\n    onFailed,\n    urlEncoded,\n    fqdn,\n    headers,\n    uuid = uniqueId('fetch-')\n  } = requestOptions;\n\n  const dispatchPayload = omit(requestOptions.dispatchPayload || {}, \"type\");\n  const customHeaders = headers || {};\n\n  const [successType, errorType, requestType] = types;\n\n  // Fetch Endpoint\n  const fetchOptions = {\n    method: method || \"GET\",\n    headers: {\n      Accept: \"application/json\",\n      ...customHeaders\n    }\n  };\n\n  // Inject JWT Token\n  if (auth) {\n    const token = storage.getItem(\"accessToken\");\n\n    if (token) {\n      fetchOptions.headers.Authorization = token;\n    } else {\n      return next({\n        ...dispatchPayload,\n        type: API_NO_TOKEN_STORED,\n        uuid\n      });\n    }\n  }\n\n  // ContentType\n  if (json) {\n    fetchOptions.headers[\"Content-Type\"] = \"application/json\";\n    fetchOptions.body = JSON.stringify(body || {});\n  }\n\n  // x-www-form-urlencoded\n  if (urlEncoded) {\n    fetchOptions.headers[\"Content-Type\"] = \"application/x-www-form-urlencoded\";\n    fetchOptions.body = qs.stringify(body || {});\n  }\n\n  // FormData\n  if (formData) {\n    fetchOptions.body = new FormData();\n    forEach(body, (val, key) => {\n      if (val) {\n        if (val instanceof FileList) {\n          [].forEach.call(val, file => fetchOptions.body.append(key, file));\n        } else {\n          fetchOptions.body.append(key, val);\n        }\n      }\n    });\n  }\n\n  const response;\n  const responseJson;\n\n  try {\n    const url = `${fqdn || storage.getItem(\"host\") || \"/api\"}${entrypoint}`;\n    // Before Request\n    if (requestType) {\n      next({\n        ...dispatchPayload,\n        type: requestType,\n        entrypoint,\n        url,\n        fetchOptions,\n        uuid\n      });\n    }\n\n    // Request Animation Start\n    next({\n      ...dispatchPayload,\n      type: API_REQUEST_START,\n      uuid\n    });\n\n    response = await fetch(url, fetchOptions);\n\n    // Request Animation End\n    next({\n      ...dispatchPayload,\n      type: API_REQUEST_END,\n      uuid\n    });\n\n    if (response.ok) {\n      if (response.status === 204) {\n        responseJson = {};\n      } else {\n        responseJson = await response.json();\n      }\n    } else {\n      responseJson = await response.json();\n\n      if (onFailed) {\n        onFailed(response.message, responseJson, response);\n      }\n\n      return next({\n        ...dispatchPayload,\n        error: response.message,\n        payload: responseJson,\n        response,\n        type: errorType,\n        uuid\n      });\n    }\n  } catch (error) {\n    if (onFailed) {\n      onFailed(error.message, error, response);\n    }\n\n    if (errorType) {\n      next({\n        ...dispatchPayload,\n        error,\n        response,\n        type: errorType,\n        uuid\n      });\n    }\n\n    return console.error(error);\n  }\n\n  if (onSuccess) {\n    onSuccess(responseJson, response);\n  }\n\n  return next({\n    ...dispatchPayload,\n    payload: responseJson,\n    response,\n    type: successType,\n    uuid\n  });\n};\n"]}